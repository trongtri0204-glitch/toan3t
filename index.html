<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOÁN 3T - Hệ Thống Kiểm Tra - ThS. Trần Trọng Trị</title>
    
    <link rel="stylesheet" href="style.css">
    <script src="data.js"></script>

    <script>
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || // F12
                (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || // Ctrl+Shift+I/J/C
                (e.ctrlKey && e.keyCode == 85) || // Ctrl+U
                (e.ctrlKey && e.keyCode == 83)) { // Ctrl+S
                alert("Thầy Trị nhắc: Tập trung làm bài, không sử dụng công cụ hỗ trợ em nhé!");
                return false;
            }
        };
    </script>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
        options: { processHtmlClass: 'mathjax-process' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="timer-box">90:00</div>

<body oncontextmenu="return false;">

<div id="timer-box">90:00</div>

<div id="nameModal">
    <div class="box-container">
        <h2 style="color:var(--gold)">TOÁN 3T - HỆ THỐNG KIỂM TRA</h2>
        <p>ThS. Trần Trọng Trị - GV Chuyên Toán Trường THPT Gia Định</p>
        
        <div class="login-container">
            <div class="input-group" style="margin-bottom: 15px;">
                <label for="studentName" style="font-weight: bold; display: block; margin-bottom: 5px;">Họ và Tên:</label>
                <input type="text" id="studentName" class="name-input" placeholder="Nhập họ và tên..." style="width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: 5px; font-size: 16px; background-color: #0d1117; color: white; box-sizing: border-box;">
            </div>

            <div class="input-group" style="margin-bottom: 15px;">
                <label for="studentSBD" style="font-weight: bold; display: block; margin-bottom: 5px;">Số báo danh:</label>
                <input type="number" id="studentSBD" class="name-input" placeholder="Nhập SBD..." style="width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: 5px; font-size: 16px; background-color: #0d1117; color: white; box-sizing: border-box;">
            </div>

            <div class="input-group" style="margin-bottom: 15px;">
                <label for="stu-grade" style="font-weight: bold; display: block; margin-bottom: 5px;">Khối:</label>
                <select id="stu-grade" onchange="updateClassList()" style="width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: 5px; font-size: 16px; background-color: #0d1117; color: white; outline: none; cursor: pointer;">
                    <option value="">-- Chọn Khối --</option>
                    <option value="12">Khối 12</option>
                    <option value="11">Khối 11</option>
                    <option value="10">Khối 10</option>
                </select>
            </div>

            <div id="class-container" class="input-group" style="margin-bottom: 25px; display: none;">
                <label for="stu-class" style="font-weight: bold; display: block; margin-bottom: 5px;">Lớp:</label>
                <select id="stu-class" style="width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: 5px; font-size: 16px; background-color: #0d1117; color: white; outline: none; cursor: pointer;">
                    <option value="">-- Chọn lớp của bạn --</option>
                </select>
            </div>
        </div>
        
        <button class="submit-btn" onclick="goToMenu()">TIẾP TỤC</button>
    </div>
</div>

<div id="menuModal" style="display:none;">
    <div class="box-container">
        <h2 id="menu-title" style="color:var(--gold)">CHỌN CHUYÊN ĐỀ</h2>
        <div id="menu-list" class="list-group"></div>
        <p id="back-link" style="display:none; color:var(--accent); cursor:pointer; margin-top:15px;">← Quay lại</p>
    </div>
</div>

<header id="quiz-header" style="display:none;">
    <h1 id="exam-title-main" style="color:var(--gold); font-size: 1.4rem;">ĐỀ KIỂM TRA</h1>
    <p style="margin: 0; font-size: 0.85rem;">ThS. Trần Trọng Trị - GV Chuyên Toán Trường THPT Gia Định</p>
</header>

<div class="nav-section" id="nav-section">
    <div class="nav-label">Phần I</div><div id="nav-p1" class="nav-group"></div>
    <div class="nav-label">Phần II</div><div id="nav-p2" class="nav-group"></div>
    <div class="nav-label">Phần III</div><div id="nav-p3" class="nav-group"></div>
</div>

<div class="game-container" id="game-main">
    <div class="quiz-card mathjax-process">
        <div id="part-info" class="part-indicator"></div>
        <span id="q-title" style="color:var(--accent); font-weight:bold; margin-bottom:10px; display:block;"></span>
        <div id="q-text" style="font-size:1.1rem; line-height:1.8; margin-bottom:15px;"></div>
        <div id="ans-zone" class="options-grid"></div>
        <div style="display:flex; gap:10px; margin-top: auto; padding-top:20px;">
            <button class="menu-btn" style="flex:1" onclick="moveQ(-1)">TRƯỚC</button>
            <button class="menu-btn" style="flex:1; background:var(--accent); color:black" onclick="moveQ(1)">SAU</button>
        </div>
    </div>
    <div class="sidebar">
        <div id="numpad-container" style="background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--accent); text-align:center; margin-bottom:15px; display:none;">
            <div id="disp" style="background:#000; color:var(--accent); font-size:2rem; padding:10px; border-radius:8px; margin-bottom:10px; font-family:monospace;">- - -</div>
            <div id="numpad-btns" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;"></div>
        </div>
        <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid #30363d; text-align:center;">
            <p style="font-size:0.9rem; margin-bottom:10px;">HS: <b id="stu-name-display"></b><br>Lớp: <b id="stu-class-display"></b></p>
            <button class="submit-btn" style="background:var(--wrong); color:white" onclick="submitTest()">NỘP BÀI</button>
        </div>
    </div>
</div>

<div id="final-area" class="mathjax-process">
    <div class="box-container" style="max-width:100%">
        <h2 style="color:var(--gold)">KẾT QUẢ</h2>
        <h3 id="final-score" style="font-size:3rem; color:var(--accent); margin:10px 0;"></h3>
        <p id="score-comment" style="font-weight:bold; font-size:1.2rem; color: #fff;"></p>
    </div>
    <div id="sol-content"></div>
    <button class="submit-btn" style="margin-top:20px" onclick="location.reload()">THI LẠI</button>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzr17ZbMvdQWnX-uAMCJnz1sW_6rWf_WdvzZqJicId2dl-A5cIR1L-j99raQmevE_w-EA/exec";
    let studentName = "", studentClass = "", currentQuestions = [], userAnswers = [], currentIdx = 0, timeLeft = 90 * 60, timerInterval, isFinished = false;
    let quizStartTime = ""; // Thời gian bắt đầu mở đề
    let studentSBD = "";
    let cheatCount = 0; // Biến đếm số lần học sinh rời khỏi tab/trình duyệt
    const classData = {
    "12": ["123T","12CT", "12CH", "12CL", "12CTIN", "12CA", "12CV", "12T",  "12HS1", "12HS2", "12L", "12XH1", "12XH2", "12TN1", "12TN2", "12TN3", "12TN4", "12TN5", "12TN6", "12TN7", "12TN8", "12TN9",  "Khác"],
    "11": ["123T","11CT", "11CH", "11CL", "11CTIN", "11CA", "11CV", "11T",  "11HS", "11L", "11XH1", "11XH2", "11TN1", "11TN2", "11TN3", "11TN4", "11TN5", "11TN6", "11TH1", "11TH2",  "Khác"],
    "10": ["123T","10T1", "1OT2", "10TIN", "10L1", "1OL2", "1OA1", "10A2",  "10H1", "10H2", "10XH1", "11XH2", "10TN1", "10TN2", "10TN3", "10TN4", "10TN5", "10TN6", "10TH1", "10TH2","10TH3",  "Khác"]
};

// Hàm này để khi học sinh chọn Khối, ô Lớp sẽ tự hiện ra danh sách tương ứng
function updateClassList() {
    const grade = document.getElementById('stu-grade').value;
    const classSelect = document.getElementById('stu-class');
    const classContainer = document.getElementById('class-container');
    
    classSelect.innerHTML = '<option value="">-- Chọn lớp của bạn --</option>';
    
    if (grade && classData[grade]) {
        classContainer.style.display = 'block'; // Hiện ô chọn lớp
        classData[grade].forEach(cls => {
            let opt = document.createElement('option');
            opt.value = cls;
            opt.innerText = cls;
            classSelect.appendChild(opt);
        });
    } else {
        classContainer.style.display = 'none'; // Ẩn nếu chưa chọn khối
    }
}
    function goToMenu() {
    studentName = document.getElementById('studentName').value.trim();
    studentSBD = document.getElementById('studentSBD').value.trim();
    studentClass = document.getElementById('stu-class').value;

    if (!studentName || !studentSBD || !studentClass) {
        return alert("Thầy mời bạn điền đầy đủ Họ tên, SBD và chọn Lớp nhé!");
    }
    
    document.getElementById('nameModal').style.display = 'none';
    
    // Đảm bảo Modal Menu của thầy có ID là menuModal
    const menuModal = document.getElementById('menuModal');
    if (menuModal) {
        menuModal.style.display = 'flex';
        renderClassMenu();
    } else {
        // Nếu thầy chưa có menuModal, thầy có thể cho bắt đầu Quiz ngay hoặc hiện Menu
        alert("Lỗi: Không tìm thấy Menu chọn đề!");
    }
}

    function renderClassMenu() {
        document.getElementById('menu-title').innerText = "CHỌN KHỐI LỚP";
        document.getElementById('back-link').style.display = 'none';
        const list = document.getElementById('menu-list');
        list.innerHTML = `
            <button class="menu-btn" onclick="renderTopicList('12')">KHỐI 12</button>
            <button class="menu-btn" onclick="renderTopicList('11')">KHỐI 11</button>
            <button class="menu-btn" onclick="renderTopicList('10')">KHỐI 10</button>
        `;
    }

    function renderTopicList(k) {
    // Ép kiểu k sang số để khớp với file data.js
    const gradeKey = parseInt(k); 

    document.getElementById('menu-title').innerText = "CHUYÊN ĐỀ LỚP " + gradeKey;
    document.getElementById('back-link').style.display = 'block';
    document.getElementById('back-link').onclick = renderClassMenu;
    const list = document.getElementById('menu-list');
    list.innerHTML = '';

    // Dùng gradeKey thay vì k
    if(!examDatabase[gradeKey] || examDatabase[gradeKey].length === 0) {
        list.innerHTML = "<p>Chưa có dữ liệu chuyên đề.</p>";
        return;
    }

    examDatabase[gradeKey].forEach((topicObj, index) => {
        let b = document.createElement('button'); 
        b.className = 'menu-btn';
        b.innerText = topicObj.topic; 
        // Truyền gradeKey vào đây luôn
        b.onclick = () => renderExamList(gradeKey, index);
        list.appendChild(b);
    });
}

    function renderExamList(k, tIdx) {
    const gradeKey = parseInt(k); // Thêm dòng này để chắc chắn
    const topicObj = examDatabase[gradeKey][tIdx];
    
    document.getElementById('menu-title').innerText = topicObj.topic;
    document.getElementById('back-link').onclick = () => renderTopicList(gradeKey);
    const list = document.getElementById('menu-list'); 
    list.innerHTML = '';

    topicObj.exams.forEach(exam => {
        let b = document.createElement('button'); 
        b.className = 'menu-btn';
        b.innerText = exam.title; 
        b.onclick = () => startQuiz(exam);
        list.appendChild(b);
    });
}
// Hàm theo dõi việc học sinh rời khỏi tab
document.addEventListener('visibilitychange', function() {
    // Chỉ kiểm tra khi bài thi đang diễn ra và chưa kết thúc
    if (document.getElementById('game-main').style.display === 'grid' && !isFinished) {
        if (document.hidden) {
            cheatCount++;
            
            if (cheatCount === 1) {
                alert("CẢNH BÁO LẦN 1: Bạn vừa rời khỏi trang thi! Nếu vi phạm lần nữa, hệ thống sẽ TỰ ĐỘNG NỘP BÀI.");
            } else if (cheatCount >= 2) {
                alert("VI PHẠM LẦN 2: Hệ thống đang tự động nộp bài do bạn cố tình rời khỏi trang thi!");
                finish(); // Gọi hàm kết thúc và nộp bài ngay lập tức
            }
        }
    }
});
    function startQuiz(exam) {
    // 1. Ghi nhận chính xác lúc học sinh mở đề
    quizStartTime = new Date().toISOString(); 

    // 2. Các logic trộn đề (Giữ nguyên chức năng cũ)
    let qCopy = JSON.parse(JSON.stringify(exam.questions));
    
    function shuffle(arr) { 
        for (let i = arr.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1)); 
            [arr[i], arr[j]] = [arr[j], arr[i]]; 
        } 
        return arr; 
    }

    // Trộn phần I (Trắc nghiệm 4 lựa chọn)
    let q1 = shuffle(qCopy.filter(q => q.part === 1));
    q1.forEach(q => { 
        let opts = q.a.map((t, idx) => ({ t, is: idx === q.c })); 
        shuffle(opts); 
        q.a = opts.map(o => o.t); 
        q.c = opts.findIndex(o => o.is); 
    });

    // Kết hợp các phần và khởi tạo mảng câu trả lời
    currentQuestions = [...q1, ...shuffle(qCopy.filter(q => q.part === 2)), ...shuffle(qCopy.filter(q => q.part === 3))];
    userAnswers = new Array(currentQuestions.length).fill(null);

    // =========================================================
    // LỚP BẢO MẬT 3: XÓA DỮ LIỆU GỐC TRONG BỘ NHỚ
    // (Chạy ngay sau khi đã nạp đề vào biến currentQuestions)
    // =========================================================
    if (typeof examDatabase !== 'undefined') {
        window.examDatabase = null; // Xóa database gốc để không thể soi đề khác qua Console
        console.log("Hệ thống đã mã hóa dữ liệu đề thi.");
    }
    // =========================================================

    // 3. Hiển thị giao diện (Giữ nguyên các ID và cấu trúc của thầy)
    document.getElementById('menuModal').style.display = 'none';
    document.getElementById('quiz-header').style.display = 'block';
    document.getElementById('nav-section').style.display = 'flex';
    document.getElementById('game-main').style.display = 'grid';

    // Hiển thị thông tin học sinh Gia Định
    document.getElementById('stu-name-display').innerText = studentSBD + " - " + studentName;
    document.getElementById('stu-class-display').innerText = studentClass;
    document.getElementById('exam-title-main').innerText = exam.title;

    // 4. Khởi tạo chức năng làm bài
    initNav(); 
    initNumpad(); 
    render(); 
    startTimer();
}

    function startTimer() {
        document.getElementById('timer-box').style.display = 'block';
        timerInterval = setInterval(() => {
            if(isFinished) return; timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer-box').innerText = `${m}:${s<10?'0':''}${s}`;
            if(timeLeft <= 0) finish();
        }, 1000);
    }

    function initNav() {
        const groups = [document.getElementById('nav-p1'), document.getElementById('nav-p2'), document.getElementById('nav-p3')];
        groups.forEach(g => g.innerHTML = '');
        let pCounts = [0,0,0];
        currentQuestions.forEach((q, i) => {
            pCounts[q.part-1]++;
            let b = document.createElement('button'); b.className = 'nav-btn'; b.id = 'nav-'+i; b.innerText = pCounts[q.part-1];
            b.onclick = () => { currentIdx = i; render(); }; groups[q.part-1].appendChild(b);
        });
    }

    function initNumpad() {
        const zone = document.getElementById('numpad-btns');
        const keys = [1,2,3,4,5,6,7,8,9,0,'.','-'];
        zone.innerHTML = keys.map(k => `<button class="menu-btn" style="padding:10px" onclick="pressKey('${k}')">${k}</button>`).join('') + `<button class="menu-btn" style="grid-column:span 3; background:var(--wrong)" onclick="pressKey('C')">XÓA</button>`;
    }

    function render() {
        const q = currentQuestions[currentIdx];
        let dNum = 0; for(let i=0; i<=currentIdx; i++) { if(currentQuestions[i].part === q.part) dNum++; }
        document.getElementById('part-info').innerText = "PHẦN " + ["I","II","III"][q.part-1];
        document.getElementById('q-title').innerText = "Câu " + dNum + ".";
        document.getElementById('q-text').innerHTML = q.q;
        const zone = document.getElementById('ans-zone'); zone.innerHTML = '';
        document.getElementById('numpad-container').style.display = q.type==='v3' ? 'block' : 'none';
        if(q.type==='v1') {
            q.a.forEach((opt, i) => {
                let b = document.createElement('button'); b.className = 'btn' + (userAnswers[currentIdx]===i?' selected':'');
                b.innerHTML = `<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
                b.onclick = () => { userAnswers[currentIdx]=i; render(); updateNav(); }; zone.appendChild(b);
            });
        } else if(q.type==='v2') {
            let cur = userAnswers[currentIdx] || [null,null,null,null];
            q.items.forEach((it, i) => {
                let d = document.createElement('div'); d.className = 'tf-row';
                d.innerHTML = `<span><b>${String.fromCharCode(97+i)})</b> ${it.l}</span><div>
                    <button class='btn-tf ${cur[i]===true?'active-t':''}' onclick='setTF(${i},true)'>Đúng</button>
                    <button class='btn-tf ${cur[i]===false?'active-f' :''}' onclick='setTF(${i},false)'>Sai</button></div>`;
                zone.appendChild(d);
            });
        } else { document.getElementById('disp').innerText = userAnswers[currentIdx] || "- - -"; }
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-'+currentIdx).classList.add('active');
        MathJax.typesetPromise();
    }

    function setTF(i, v) { if(!userAnswers[currentIdx]) userAnswers[currentIdx]=[null,null,null,null]; userAnswers[currentIdx][i]=v; render(); updateNav(); }
    function pressKey(k) { let cur = userAnswers[currentIdx] || ""; if(k==='C') cur=""; else if(cur.length<10) cur+=k; userAnswers[currentIdx]=cur; render(); updateNav(); }
    function moveQ(s) { let n=currentIdx+s; if(n>=0 && n<currentQuestions.length) { currentIdx=n; render(); } }
    function updateNav() {
    currentQuestions.forEach((q, i) => {
        let b = document.getElementById('nav-' + i), a = userAnswers[i];
        b.classList.remove('done', 'missing');
        
        if (q.type === 'v2') {
            // Phần II: Đúng/Sai
            if (a && a.includes(null)) {
                if (a.some(v => v !== null)) b.classList.add('missing');
            } else if (a && !a.includes(null)) {
                b.classList.add('done');
            }
        } else {
            // Phần I & III: Trắc nghiệm & Điền số
            if (a !== null && a !== "") {
                b.classList.add('done');
            } else {
                // Nếu muốn bảng số câu luôn hiện đỏ những câu chưa làm:
                b.classList.add('missing'); 
            }
        }
    });
}

    function submitTest() {
    let missingList = [];
    
    currentQuestions.forEach((q, i) => {
        let a = userAnswers[i];
        let isMissing = false;
        
        // Kiểm tra từng loại câu hỏi để xác định câu chưa làm
        if (q.type === 'v2') {
            if (!a || a.includes(null)) isMissing = true;
        } else {
            if (a === null || a === "") isMissing = true;
        }

        if (isMissing) {
            // Lấy số thứ tự câu dựa theo phần (Part) để học sinh dễ tìm
            // Ví dụ: Câu 3 Phần II
            let partName = ["I", "II", "III"][q.part - 1];
            let displayNum = 0;
            for(let j=0; j<=i; j++) { if(currentQuestions[j].part === q.part) displayNum++; }
            missingList.push(`Câu ${displayNum} (Phần ${partName})`);
        }
    });

    if (missingList.length > 0) {
        // Cập nhật màu đỏ ngay lập tức cho các câu chưa làm trên bảng điều hướng
        updateNav(); 

        // Tạo nội dung thông báo liệt kê các câu còn thiếu
        let msg = `Bạn còn ${missingList.length} câu chưa hoàn thành:\n\n- ` + missingList.join('\n- ');
        msg += `\n\nBạn có muốn QUAY LẠI làm tiếp không?\n(Nhấn OK để quay lại câu chưa làm, nhấn Cancel để vẫn nộp bài)`;
        
        if (confirm(msg)) {
            // TÌM CÂU CHƯA LÀM ĐẦU TIÊN ĐỂ NHẢY ĐẾN
            let firstMissingIdx = currentQuestions.findIndex((q, i) => {
                let a = userAnswers[i];
                return (q.type === 'v2') ? (!a || a.includes(null)) : (a === null || a === "");
            });
            
            if (firstMissingIdx !== -1) {
                currentIdx = firstMissingIdx;
                render(); // Cập nhật lại giao diện câu hỏi
            }
            return; // Thoát hàm submitTest để học sinh làm bài tiếp
        }
    }
    
    // Xác nhận cuối cùng trước khi nộp
    if (confirm("Xác nhận nộp bài và xem kết quả?")) {
        finish();
    }
}

    function finish() {
    isFinished = true; 
    clearInterval(timerInterval);
    document.getElementById('timer-box').style.display = 'none';
    
    let sc = 0;
    currentQuestions.forEach((q, i) => {
        if(q.type==='v1' && userAnswers[i]==q.c) sc += 0.25;
        else if(q.type==='v2' && userAnswers[i]) {
            let c = 0; q.items.forEach((it, j) => { if(userAnswers[i][j]===it.r) c++; });
            sc += [0, 0.1, 0.25, 0.5, 1.0][c];
        } else if(q.type==='v3' && userAnswers[i]==q.c) sc += 0.5;
    });
    const score = parseFloat(sc.toFixed(2));

    // Gửi dữ liệu có kèm SBD lên Google Sheet
    fetch(GOOGLE_SCRIPT_URL, { 
    method: 'POST', 
    mode: 'no-cors', 
    body: JSON.stringify({ 
        sbd: studentSBD,
        name: studentName, 
        class: studentClass, 
        score: score,
        examTitle: document.getElementById('exam-title-main').innerText.trim(),
        startTime: quizStartTime,
        endTime: new Date().toISOString(),
        cheat: cheatCount // Thêm dòng này để báo cáo số lần rời tab
    }) 
});

    // Hiển thị kết quả (giữ nguyên các phần giao diện kết quả của thầy)
    document.getElementById('game-main').style.display='none'; 
    document.getElementById('nav-section').style.display='none'; 
    document.getElementById('quiz-header').style.display='none';
    document.getElementById('final-area').style.display='block'; 
    document.getElementById('final-score').innerText = score;

        // CẬP NHẬT: LOGIC NHẬN XÉT ĐIỂM
        const cm = document.getElementById('score-comment');
        if(score < 3.5) cm.innerText = "Bạn cần cố gắng rất nhiều!";
        else if(score < 5) cm.innerText = "Kết quả chưa đạt, cần học kỹ lại lý thuyết.";
        else if(score < 6.5) cm.innerText = "Mức trung bình, cố gắng rèn luyện thêm bài tập.";
        else if(score < 8) cm.innerText = "Khá tốt! Phát huy thêm nhé.";
        else if(score < 9) cm.innerText = "Giỏi lắm! Bạn nắm kiến thức rất vững.";
        else if(score < 10) cm.innerText = "Xuất sắc! Một kết quả tuyệt vời.";
        else cm.innerText = "Đỉnh của chóp nha.";

        let html = "";
        currentQuestions.forEach((q, i) => {
            html += `<div class='sol-card'><b>Câu ${i+1}:</b><br>${q.q}<div style='background:#0d1117; padding:15px; border-radius:8px; margin-top:10px;'>${q.sol}</div></div>`;
        });
        document.getElementById('sol-content').innerHTML = html;
        MathJax.typesetPromise();
    }

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const testMode = params.get('test'); 
        if (testMode && typeof examDatabase !== 'undefined') {
            const [k, tIdx, eIdx] = testMode.split(',');
            studentName = "Giáo Viên TEST"; studentClass = "Gia Định";
            const exam = examDatabase[k][tIdx].exams[eIdx];
            if (exam) { 
                document.getElementById('nameModal').style.display = 'none'; 
                startQuiz(exam); 
            }
        }
    };
    // --- LỚP 2: BẪY DEBUGGER (KHIẾN F12 BỊ TREO) ---
    (function() {
        setInterval(function() {
            (function(a) {
                return (function(a) {
                    return (Function('Function(arguments[0])(arguments[1])')(a, a));
                })(a);
            })(function() {
                debugger;
            });
        }, 500); // Cứ 0.5 giây sẽ kích hoạt bẫy một lần
    })();
</script>
</body>
</html>
