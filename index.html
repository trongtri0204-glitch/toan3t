<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TO√ÅN 3T - H·ªá Th·ªëng Ki·ªÉm Tra - ThS. Tr·∫ßn Tr·ªçng Tr·ªã</title>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
        options: { processHtmlClass: 'mathjax-process' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --text: #c9d1d9; --correct: #238636; --wrong: #da3633; --gold: #f1c40f; --ai: #8a2be2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; }
        
        #timer-box { position: fixed; top: 15px; right: 15px; background: #000; color: var(--gold); padding: 10px 20px; border-radius: 8px; border: 2px solid var(--gold); font-weight: bold; font-size: 1.2rem; z-index: 1000; font-family: monospace; display: none; }
        .timer-warning { color: var(--wrong) !important; border-color: var(--wrong) !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Modal & Menus */
        #nameModal, #menuModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .box-container { background: var(--card); padding: 35px; border-radius: 15px; text-align: center; border: 2px solid var(--accent); width: 95%; max-width: 600px; }
        .input-group { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        .name-input { padding: 15px; border-radius: 8px; border: 1px solid var(--accent); background: #0d1117; color: white; font-size: 1.1rem; outline: none; }
        
        .list-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .menu-btn { background: #21262d; border: 1px solid var(--accent); color: white; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: 0.3s; }
        .menu-btn:hover { background: var(--accent); color: #000; }

        /* Quiz Layout */
        header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid var(--accent); width: 100%; padding-bottom: 10px; }
        .nav-section { width: 100%; max-width: 1050px; background: #161b22; padding: 10px; border-radius: 10px; border: 1px solid #30363d; margin-bottom: 15px; display: none; flex-direction: column; }
        .nav-group { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 8px; }
        .nav-label { font-size: 0.75rem; color: var(--gold); font-weight: bold; width: 100%; text-align: center; margin-bottom: 3px; }
        .nav-btn { width: 32px; height: 32px; border-radius: 5px; border: 1px solid #30363d; background: #21262d; color: white; cursor: pointer; font-size: 0.8rem; }
        .nav-btn.active { background: var(--accent); border-color: white; font-weight: bold; }
        .nav-btn.done { border-bottom: 3px solid var(--correct); }
        .nav-btn.missing { background: #3d1a1a; border: 1px solid var(--wrong); }

        .game-container { max-width: 1050px; width: 100%; display: none; grid-template-columns: 1fr 300px; gap: 15px; }
        @media (max-width: 850px) { .game-container { grid-template-columns: 1fr; } }
        
        .quiz-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #30363d; min-height: 480px; display: flex; flex-direction: column; }
        .part-indicator { color: var(--gold); font-weight: bold; background: #21262d; padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid var(--gold); font-size: 0.9rem; }
        .options-grid { display: grid; gap: 8px; flex-grow: 1; }
        .btn { background: #21262d; border: 1px solid #30363d; color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; text-align: left; display: flex; gap: 8px; }
        .btn.selected { border-color: var(--accent); border-width: 2px; }

        .tf-row { display: flex; align-items: center; justify-content: space-between; background: #0d1117; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #30363d; }
        .btn-tf { padding: 8px 15px; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; background: #21262d; color: white; font-weight: bold; }
        .btn-tf.active-t { background: var(--correct) !important; }
        .btn-tf.active-f { background: var(--wrong) !important; }

        .submit-btn { width: 100%; padding: 15px; background: var(--gold); color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        
        #final-area { display: none; width: 100%; max-width: 900px; padding: 20px; }
        .sol-card { background: var(--card); padding: 25px; border-radius: 12px; margin-top: 20px; border: 1px solid #30363d; text-align: left; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="timer-box">90:00</div>

<div id="nameModal">
    <div class="box-container">
        <h2 style="color:var(--gold)">TO√ÅN 3T - H·ªÜ TH·ªêNG KI·ªÇM TRA</h2>
        <p>ThS. Tr·∫ßn Tr·ªçng Tr·ªã - GV Chuy√™n To√°n Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
        <div class="input-group">
            <input type="text" id="studentName" class="name-input" placeholder="H·ªç v√† T√™n h·ªçc sinh...">
            <input type="text" id="studentClass" class="name-input" placeholder="L·ªõp (V√≠ d·ª•: 12CT, 11T, 10T1...)">
        </div>
        <button class="submit-btn" onclick="goToMenu()">TI·∫æP T·ª§C</button>
    </div>
</div>

<div id="menuModal" style="display:none;">
    <div class="box-container">
        <h2 id="menu-title" style="color:var(--gold)">CH·ªåN KH·ªêI L·ªöP</h2>
        <div id="menu-list" class="list-group"></div>
        <p id="back-link" style="display:none; color:var(--accent); cursor:pointer; margin-top:15px;" onclick="renderClassMenu()">‚Üê Quay l·∫°i ch·ªçn Kh·ªëi</p>
    </div>
</div>

<header id="quiz-header" style="display:none;">
    <h1 id="exam-title-main" style="color:var(--gold); font-size: 1.4rem;">ƒê·ªÄ KI·ªÇM TRA</h1>
    <p style="margin: 0; font-size: 0.85rem;">ThS. Tr·∫ßn Tr·ªçng Tr·ªã - Tr∆∞·ªùng THPT Gia ƒê·ªãnh</p>
</header>

<div class="nav-section" id="nav-section">
    <div class="nav-label">Ph·∫ßn I</div><div id="nav-p1" class="nav-group"></div>
    <div class="nav-label">Ph·∫ßn II</div><div id="nav-p2" class="nav-group"></div>
    <div class="nav-label">Ph·∫ßn III</div><div id="nav-p3" class="nav-group"></div>
</div>

<div class="game-container" id="game-main">
    <div class="quiz-card mathjax-process">
        <div id="part-info" class="part-indicator"></div>
        <span id="q-title" style="color:var(--accent); font-weight:bold; margin-bottom:10px; display:block;"></span>
        <div id="q-text" style="font-size:1.1rem; line-height:1.8; margin-bottom:15px;"></div>
        <div id="ans-zone" class="options-grid"></div>
        <div style="display:flex; gap:10px; margin-top: auto; padding-top:20px;">
            <button class="menu-btn" style="flex:1" onclick="moveQ(-1)">TR∆Ø·ªöC</button>
            <button class="menu-btn" style="flex:1; background:var(--accent); color:black" onclick="moveQ(1)">SAU</button>
        </div>
    </div>
    <div class="sidebar">
        <div id="numpad-container" style="background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--accent); text-align:center; margin-bottom:15px; display:none;">
            <div id="disp" style="background:#000; color:var(--accent); font-size:2rem; padding:10px; border-radius:8px; margin-bottom:10px; font-family:monospace;">- - -</div>
            <div id="numpad-btns" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;"></div>
        </div>
        <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid #30363d; text-align:center;">
            <p style="font-size:0.9rem; margin-bottom:10px;">HS: <b id="stu-name-display"></b><br>L·ªõp: <b id="stu-class-display"></b></p>
            <button class="submit-btn" style="background:var(--wrong); color:white" onclick="submitTest()">N·ªòP B√ÄI</button>
        </div>
    </div>
</div>

<div id="final-area" class="mathjax-process">
    <div class="box-container" style="max-width:100%">
        <h2 style="color:var(--gold)">K·∫æT QU·∫¢</h2>
        <h3 id="final-score" style="font-size:3rem; color:var(--accent); margin:10px 0;"></h3>
        <p id="score-comment" style="font-weight:bold; font-size:1.2rem;"></p>
    </div>
    <div id="sol-content"></div>
    <button class="submit-btn" style="margin-top:20px" onclick="location.reload()">THI L·∫†I</button>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjZBQWpiklw60rfJViq7FTkrnY7J9bFrvlLMB9_SLHlHKvSzQBuV3mZ-fd3jT6ofdWnA/exec";

    // --- DATABASE ƒê·ªÄ THI ---
    const examDatabase = {
        "12": [
            { 
                topic: "Nguy√™n h√†m - T√≠ch ph√¢n",
                exams: [
                    
                       {
    title: "ƒê·ªÅ 01: Nguy√™n h√†m - T√≠ch ph√¢n",
    questions: [
        // PH·∫¶N I (12 c√¢u)
        { part: 1, type: 'v1', q: "M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y l√† <b>sai</b>?", a: ["$\\displaystyle \\int f'(x) dx = f(x)+C$","$\\displaystyle \\int [f(x)+g(x)] dx = \\int f(x)dx + \\int g(x)dx$","$\\displaystyle \\int k f(x) dx = k \\int f(x)dx$","$\\displaystyle \\int [f(x)-g(x)] dx = \\int f(x)dx - \\int g(x)dx$"], c: 2, sol: "T√≠nh ch·∫•t $\\displaystyle \\int k f(x) dx = k \\int f(x)dx$ ch·ªâ ƒë√∫ng khi h·∫±ng s·ªë $k \\neq 0$. N·∫øu $k=0$, v·∫ø tr√°i l√† $\\int 0 dx = C$, v·∫ø ph·∫£i l√† $0 \\cdot \\int f(x)dx = 0$." },
        { part: 1, type: 'v1', q: "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x$ l√†:", a: ["$-\\sin x + C$", "$\\sin x + C$", "$\\cos x + C$", "$-\\cos x + C$"], c: 1, sol: "V√¨ $\\displaystyle (\\sin x + C)' = \\cos x$ n√™n $\\displaystyle \\int \\cos x dx = \\sin x + C$." },
        { part: 1, type: 'v1', q: "T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = 5^x$.", a: ["$5^x + C$", "$5^x \\ln 5 + C$", "$\\displaystyle \\dfrac{5^x}{\\ln 5} + C$", "$\\displaystyle \\dfrac{5^{x+1}}{x+1} + C$"], c: 2, sol: "√Åp d·ª•ng c√¥ng th·ª©c nguy√™n h√†m h√†m s·ªë m≈©: $\\displaystyle \\int a^x dx = \\dfrac{a^x}{\\ln a} + C$." },
        { part: 1, type: 'v1', q: "Cho h√†m s·ªë $f(x)$ li√™n t·ª•c tr√™n $K$ v√† $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$ tr√™n $K$. Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng?", a: ["$f'(x) = F(x)$", "$F'(x) = f(x)$", "$F(x) = f(x)$", "$F'(x) = f'(x)$"], c: 1, sol: "Theo ƒë·ªãnh nghƒ©a nguy√™n h√†m: H√†m s·ªë $F(x)$ ƒë∆∞·ª£c g·ªçi l√† nguy√™n h√†m c·ªßa $f(x)$ tr√™n $K$ n·∫øu $F'(x) = f(x)$ v·ªõi m·ªçi $x \\in K$." },
        { part: 1, type: 'v1', q: "T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\dfrac{1}{x^2}$.", a: ["$\\displaystyle \\dfrac{1}{x} + C$", "$\\displaystyle -\\dfrac{1}{x} + C$", "$\\displaystyle \\dfrac{1}{2x} + C$", "$\\ln x^2 + C$"], c: 1, sol: "Ta c√≥ $\\displaystyle \\int \\dfrac{1}{x^2} dx = \\int x^{-2} dx = \\dfrac{x^{-1}}{-1} + C = -\\dfrac{1}{x} + C$." },
        { part: 1, type: 'v1', q: "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = x^2 - 3x + \\dfrac{1}{x}$ l√†:", a: ["$F(x) = 2x - 3 - 1/x^2 + C$","$\\displaystyle F(x) = \\dfrac{x^3}{3} - \\dfrac{3}{2}x^2 + \\ln|x| + C$","$\\displaystyle F(x) = \\dfrac{x^3}{3} + \\frac{3}{2}x^2 + \\ln x + C$","$\\displaystyle F(x) = \\dfrac{x^3}{3} - \\dfrac{3}{2}x^2 + \\ln x + C$"], c: 1, sol: "L·∫•y nguy√™n h√†m t·ª´ng s·ªë h·∫°ng: $\\int x^2 dx = x^3/3$; $\\int -3x dx = -3x^2/2$; $\\int (1/x) dx = \\ln|x|$." },
        { part: 1, type: 'v1', q: "Cho $a, b, c \\in K$ v√† h√†m s·ªë $f(x)$ li√™n t·ª•c tr√™n $K$. M·ªánh ƒë·ªÅ n√†o sau ƒë√¢y <b>sai</b>?", a: ["$\\displaystyle \\int_a^b f(x)dx + \\int_c^b f(x)dx = \\int_a^c f(x)dx$","$\\displaystyle \\int_a^b f(x)dx = \\int_a^b f(t)dt$","$\\displaystyle \\int_a^b f(x)dx = -\\int_b^a f(x)dx$","$\\displaystyle \\int_a^a f(x)dx = 0$"], c: 0, sol: "T√≠nh ch·∫•t n·ªëi c·∫≠n ƒë√∫ng ph·∫£i l√†: $\\displaystyle \\int_a^c f(x)dx + \\int_c^b f(x)dx = \\int_a^b f(x)dx$." },
        { part: 1, type: 'v1', q: "Cho $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)$. Hi·ªáu s·ªë $F(0)-F(1)$ b·∫±ng:", a: ["$\\displaystyle \\int_0^1 f(x)dx$", "$\\displaystyle \\int_0^1 F(x)dx$", "$\\displaystyle \\int_1^0 F(x)dx$", "$\\displaystyle \\int_1^0 f(x)dx$"], c: 3, sol: "Theo c√¥ng th·ª©c Newton-Leibniz: $\\displaystyle \\int_1^0 f(x)dx = F(0) - F(1)$." },
        { part: 1, type: 'v1', q: "Cho $f(1)=2, f(3)=9$. T√≠nh t√≠ch ph√¢n $I = \\displaystyle \\int_1^3 f'(x)dx$.", a: ["11", "7", "2", "18"], c: 1, sol: "Ta c√≥ $\\displaystyle I = f(x) \\big|_1^3 = f(3) - f(1) = 9 - 2 = 7$." },
        { part: 1, type: 'v1', q: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi ƒë·ªì th·ªã h√†m s·ªë $y=f(x)$ li√™n t·ª•c, tr·ª•c ho√†nh v√† hai ƒë∆∞·ªùng th·∫≥ng $x=a, x=b$ ($a < b$) l√†:", a: ["$S=\\displaystyle \\pi \\int_a^b f^2(x)dx$", "$S=\\displaystyle \\int_a^b f(x)dx$", "$S=\\displaystyle \\pi \\int_a^b |f(x)|dx$", "$S=\\displaystyle \\int_a^b |f(x)|dx$"], c: 3, sol: "ƒê√¢y l√† c√¥ng th·ª©c c∆° b·∫£n t√≠nh di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi 1 ƒë·ªì th·ªã v√† tr·ª•c ho√†nh." },
        { part: 1, type: 'v1', q: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng v·ªÅ di·ªán t√≠ch $S$ c·ªßa h√¨nh ph·∫≥ng trong h√¨nh v·∫Ω? <div class='img-container'><img src='images/12/nguyen_ham_tich_phan/de1/cau11.png'></div>", a: ["$\\displaystyle S = \\int_a^b [f_2(x)-f_1(x)] dx$", "$\\displaystyle S = \\int_a^b [f_1(x)-f_2(x)] dx$", "$\\displaystyle S = \\pi \\int_a^b [f_1(x)-f_2(x)]^2 dx$", "$\\displaystyle S = \\pi \\int_a^b [f_1(x)-f_2(x)] dx$"], c: 1, sol: "Tr√™n ƒëo·∫°n $[a;b]$, ƒë·ªì th·ªã h√†m s·ªë $y=f_1(x)$ n·∫±m ph√≠a tr√™n ƒë·ªì th·ªã $y=f_2(x)$ n√™n $S = \\int_a^b |f_1(x)-f_2(x)| dx = \\int_a^b [f_1(x)-f_2(x)] dx$." },
        { part: 1, type: 'v1', q: "Th·ªÉ t√≠ch v·∫≠t th·ªÉ gi·ªõi h·∫°n b·ªüi hai m·∫∑t ph·∫≥ng $x=a, x=b$ ($a < b$) c√≥ thi·∫øt di·ªán t·∫°i $x$ l√† $S(x)$ ƒë∆∞·ª£c t√≠nh b·ªüi:", a: ["$\\displaystyle V = \\int_b^a S(x)dx$", "$\\displaystyle V = \\pi \\int_a^b S(x)dx$", "$V = \\pi \\int_a^b S(x)^2dx$", "$\\displaystyle \\int_a^b S(x)dx$"], c: 3, sol: "C√¥ng th·ª©c t√≠nh th·ªÉ t√≠ch v·∫≠t th·ªÉ theo thi·∫øt di·ªán $S(x)$ kh√¥ng c√≥ h·∫±ng s·ªë $\\pi$." },

        // PH·∫¶N II (4 c√¢u)
        { part: 2, num: 1, type: 'v2', q: "Cho h√†m s·ªë $f(x) = \\dfrac{x^2+1}{x}$ x√°c ƒë·ªãnh tr√™n $(0;+\\infty)$. G·ªçi $F(x)$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$ tr√™n kho·∫£ng ƒë√≥.", items: [ {l: "$F(x) = f'(x)$", r: false}, {l: "$F(x)+2025$ c≈©ng l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$", r: true}, {l: "M·ªôt nguy√™n h√†m c·ªßa $f(x)$ l√† $F(x) = x^2 + \\ln x + 2025$", r: false}, {l: "N·∫øu $F(1) = 1,5$ th√¨ $F(x) = 0,5x^2 + \\ln x + 1$", r: true} ], sol: "a) Sai v√¨ $F'(x)=f(x)$. b) ƒê√∫ng v√¨ nguy√™n h√†m sai kh√°c h·∫±ng s·ªë C. c) Sai v√¨ $\\int x dx = x^2/2$. d) ƒê√∫ng v√¨ $F(1)=0,5(1)^2+\\ln 1 + 1 = 1,5$." },
        { part: 2, num: 2, type: 'v2', q: "Cho h√†m s·ªë $f(x) = 6x^5 - x^e$. G·ªçi $\\displaystyle I = \\int_a^b 6x^5 dx$ v√† $\\displaystyle J = \\int_a^b x^e dx$.", items: [ {l: "$\\displaystyle \\int 6x^5 dx = 6 \\int x^5 dx$", r: true}, {l: "$\\displaystyle \\int f(x) dx = I + J$", r: false}, {l: "$\\displaystyle J = \\frac{b^{e+1}-a^{e+1}}{e+1}$", r: true}, {l: "$\\displaystyle \\int_0^1 f(x)dx = 1 - \\frac{1}{e+1}$", r: true} ], sol: "a) ƒê√∫ng (t√≠nh ch·∫•t nguy√™n h√†m). b) Sai (ƒë·ªÅ b√†i cho $f(x)$ l√† hi·ªáu). c) ƒê√∫ng (c√¥ng th·ª©c t√≠ch ph√¢n l≈©y th·ª´a). d) ƒê√∫ng v√¨ $\\int_0^1 (6x^5-x^e)dx = (x^6 - x^{e+1}/(e+1))|_0^1 = 1 - 1/(e+1)$." },
        { part: 2, num: 3, type: 'v2', q: "Cho h√†m s·ªë $\\displaystyle f(x) = x + 5 - \\dfrac{6}{x}$ x√°c ƒë·ªãnh tr√™n $\\mathbb{R}\\backslash\\{0\\}$.", items: [ {l: "ƒê·∫°o h√†m c·ªßa h√†m s·ªë l√† $f'(x) = 1 + 6/x^2$", r: true}, {l: "$\\displaystyle \\int f(x)dx = 0,5x^2 + 5x - 6\\ln|x| + C$", r: true}, {l: "V·ªõi m·ªçi $F(x)$ l√† nguy√™n h√†m c·ªßa $f(x)$, ta c√≥ $F(2) - F(1) = \\int_1^2 f(x)dx$", r: true}, {l: "N·∫øu $G(x)$ l√† nguy√™n h√†m th·ªèa $G(-2)=0$ th√¨ $G(-6) = -13 - 6\\ln 3$", r: true} ], sol: "T·∫•t c·∫£ c√°c √Ω ƒë·ªÅu ƒë√∫ng d·ª±a tr√™n quy t·∫Øc t√≠nh ƒë·∫°o h√†m, nguy√™n h√†m c∆° b·∫£n v√† ƒë·ªãnh l√Ω Newton-Leibniz." },
        { part: 2, num: 4, type: 'v2', q: "Cho b·∫£ng bi·∫øn thi√™n c·ªßa h√†m s·ªë $y=f'(x)$ nh∆∞ h√¨nh v·∫Ω: <div class='img-container'><img src='images/12/nguyen_ham_tich_phan/de1/cau4_ds.png'></div>", items: [ {l: "$\\displaystyle \\int_2^5 f'(x)dx = f(5)-f(2)$", r: true}, {l: "$f'(x) < 0$ tr√™n kho·∫£ng $(2;3)$", r: true}, {l: "H√†m s·ªë $y=f(x)$ ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(3;5)$", r: true}, {l: "Gi√° tr·ªã $f(2) > f(3)$", r: true} ], sol: "a) ƒê√∫ng (ƒë·ªãnh l√Ω). b) ƒê√∫ng (nh√¨n BBT ƒëo·∫°n [2;3] n·∫±m d∆∞·ªõi tr·ª•c ho√†nh). c) ƒê√∫ng (ƒëo·∫°n [3;5] $f'(x)>0$). d) ƒê√∫ng v√¨ h√†m ngh·ªãch bi·∫øn tr√™n $(2;3)$." },

        // PH·∫¶N III (6 c√¢u)
        { part: 3, num: 1, type: 'v3', q: "Bi·∫øt $\\displaystyle \\int (\\sin x - \\cos x)^2 dx = x + \\dfrac{1}{a} \\cos bx + C$. T√≠nh gi√° tr·ªã $a+b$.", c: "4", sol: "Khai tri·ªÉn: $(\\sin x - \\cos x)^2 = 1 - 2\\sin x \\cos x = 1 - \\sin 2x$. <br> Nguy√™n h√†m: $\\int (1-\\sin 2x)dx = x + \\frac{1}{2}\\cos 2x + C$. <br> Suy ra $a=2, b=2 \\Rightarrow a+b=4$." },
        { part: 3, num: 2, type: 'v3', q: "Cho h√†m s·ªë $f(x), g(x)$ li√™n t·ª•c. Bi·∫øt $\\int_2^7 [2f(x)+3g(x)]dx=2$ v√† $\\int_2^7 [f(x)-2g(x)]dx=4$. T√≠nh $\\int_2^7 [f(x)-g(x)]dx$ (l√†m tr√≤n ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n).", c: "3.14", sol: "ƒê·∫∑t $u = \\int_2^7 f(x)dx, v = \\int_2^7 g(x)dx$. <br> Ta c√≥ h·ªá: $2u+3v=2$ v√† $u-2v=4$. Gi·∫£i h·ªá ƒë∆∞·ª£c $u=16/7, v=-6/7$. <br> Khi ƒë√≥ $u-v = 16/7 - (-6/7) = 22/7 \\approx 3.14$." },
        { part: 3, num: 3, type: 'v3', q: "Cho $F(x) = (ax^2+bx+c)e^x$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = (x^2+1)e^x$. T√≠nh t·ªïng $a+b+c$.", c: "2", sol: "ƒê·∫°o h√†m $F'(x) = [ax^2 + (2a+b)x + (b+c)]e^x$. <br> ƒê·ªìng nh·∫•t h·ªá s·ªë v·ªõi $(x^2+1)e^x$: $a=1; 2a+b=0; b+c=1$. <br> Gi·∫£i ra $a=1, b=-2, c=3 \\Rightarrow a+b+c=2$." },
        { part: 3, num: 4, type: 'v3', q: "Cho h√†m s·ªë $f(x) = 3x^2-x-9$ khi $x \\ge 2$ v√† $f(x) = x-1$ khi $x < 2$. T√≠nh t√≠ch ph√¢n $I = \\displaystyle \\int_0^3 f(x)dx$.", c: "7.5", sol: "T√°ch t√≠ch ph√¢n: $I = \\int_0^2 (x-1)dx + \\int_2^3 (3x^2-x-9)dx$. <br> $I = (x^2/2 - x)|_0^2 + (x^3 - x^2/2 - 9x)|_2^3 = 0 + 7,5 = 7,5$." },
        { part: 3, num: 5, type: 'v3', q: "T√≠nh gi√° tr·ªã $f(3)$ bi·∫øt di·ªán t√≠ch c√°c h√¨nh ph·∫≥ng $S_A=4, S_B=10$ v√† $f(0)=2$ d·ª±a tr√™n ƒë·ªì th·ªã h√†m s·ªë ƒë·∫°o h√†m $f'(x)$ nh∆∞ h√¨nh v·∫Ω: <div class='img-container'><img src='images/12/nguyen_ham_tich_phan/de1/cau5_kq.png'></div>", c: "-4", sol: "Ta c√≥ $\\int_0^3 f'(x)dx = f(3)-f(0)$. <br> M·∫∑t kh√°c $\\int_0^3 f'(x)dx = S_A - S_B = 4 - 10 = -6$. <br> Suy ra $f(3) = f(0) - 6 = 2 - 6 = -4$." },
        {
                        part: 3,
                        num: 6,
                        type: 'v3',
                        q: "M·ªôt khu√¥n vi√™n h√¨nh n·ª≠a ƒë∆∞·ªùng tr√≤n gi·ªõi h·∫°n b·ªüi $y=x^2$ v√† $y=\\sqrt{20-x^2}$. T√≠nh chi ph√≠ tr·ªìng hoa v·ªõi gi√° 250 (ng√†n ƒë·ªìng/$m^2$), l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã. <div class='img-container'><img src='images/12/nguyen_ham_tich_phan/de1/cau6_kq.png'></div>",
                        c: "4985",
                        sol: "<div class='img-container' style='margin-bottom:15px;'>" +
                             "<img src='images/12/nguyen_ham_tich_phan/de1/cau6_kq_lg.png' style='max-width:100%; border: 1px solid #30363d; border-radius:8px;'>" +
                             "</div>" +
                             "<b>Gi·∫£i chi ti·∫øt:</b><br>" +
                             "1. Ph∆∞∆°ng tr√¨nh ho√†nh ƒë·ªô giao ƒëi·ªÉm: $x^2 = \\sqrt{20-x^2} \\Leftrightarrow x^4 + x^2 - 20 = 0 \\Leftrightarrow x^2 = 4 \\Leftrightarrow x = \\pm 2$.<br>" +
                             "2. Di·ªán t√≠ch h√¨nh ph·∫≥ng: $\\displaystyle S = \\int_{-2}^2 \\left( \\sqrt{20-x^2} - x^2 \\right) dx \\approx 19.9396 m^2$.<br>" +
                             "3. T·ªïng chi ph√≠: $19.9396 \\cdot 250 \\approx 4985$ (ng√†n ƒë·ªìng)."
                    } // ƒê√£ s·ª≠a d·∫•u ƒë√≥ng ngo·∫∑c c√¢u 6
                ] // ƒê√£ th√™m d·∫•u ƒë√≥ng m·∫£ng questions
            },
            { title: "ƒê·ªÅ 02: ·ª®ng d·ª•ng t√≠ch ph√¢n", questions: [] }
        ]
    },
    {
        topic: "H√¨nh h·ªçc Oxyz",
        exams: [
            { title: "ƒê·ªÅ 01: H·ªá t·ªça ƒë·ªô", questions: [] },
            { title: "ƒê·ªÅ 02: M·∫∑t ph·∫≥ng", questions: [] }
        ]
    }
],
    };

    let studentName = "", studentClass = "", currentQuestions = [], userAnswers = [], currentIdx = 0, timeLeft = 90 * 60, timerInterval, isFinished = false;

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function goToMenu() {
        studentName = document.getElementById('studentName').value;
        studentClass = document.getElementById('studentClass').value;
        if(!studentName || !studentClass) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('menuModal').style.display = 'flex';
        renderClassMenu();
    }

    // C·∫§P 1: Ch·ªçn Kh·ªëi
    function renderClassMenu() {
        document.getElementById('menu-title').innerText = "CH·ªåN KH·ªêI L·ªöP";
        document.getElementById('back-link').style.display = 'none';
        const list = document.getElementById('menu-list');
        list.innerHTML = `
            <button class="menu-btn" onclick="renderTopicList('12')">KH·ªêI 12</button>
            <button class="menu-btn" onclick="renderTopicList('11')">KH·ªêI 11</button>
            <button class="menu-btn" onclick="renderTopicList('10')">KH·ªêI 10</button>
        `;
    }

    // C·∫§P 2: Ch·ªçn Chuy√™n ƒë·ªÅ
    function renderTopicList(k) {
        document.getElementById('menu-title').innerText = "CHUY√äN ƒê·ªÄ L·ªöP " + k;
        document.getElementById('back-link').style.display = 'block';
        document.getElementById('back-link').onclick = renderClassMenu;
        const list = document.getElementById('menu-list');
        list.innerHTML = '';
        
        if(!examDatabase[k] || examDatabase[k].length === 0) {
            list.innerHTML = "<p>Hi·ªán ch∆∞a c√≥ chuy√™n ƒë·ªÅ n√†o.</p>";
            return;
        }

        examDatabase[k].forEach((topicObj, index) => {
            let b = document.createElement('button');
            b.className = 'menu-btn';
            b.innerText = topicObj.topic;
            b.onclick = () => renderExamList(k, index);
            list.appendChild(b);
        });
    }

    // C·∫§P 3: Ch·ªçn ƒê·ªÅ
    function renderExamList(k, topicIndex) {
        const topicObj = examDatabase[k][topicIndex];
        document.getElementById('menu-title').innerText = topicObj.topic;
        document.getElementById('back-link').style.display = 'block';
        document.getElementById('back-link').onclick = () => renderTopicList(k);
        const list = document.getElementById('menu-list');
        list.innerHTML = '';

        if(!topicObj.exams.length) {
            list.innerHTML = "<p>Hi·ªán ch∆∞a c√≥ ƒë·ªÅ thi n√†o.</p>";
            return;
        }

        topicObj.exams.forEach(exam => {
            let b = document.createElement('button');
            b.className = 'menu-btn';
            b.innerText = exam.title;
            b.onclick = () => startQuiz(exam);
            list.appendChild(b);
        });
    }

    function startQuiz(exam) {
        if(!exam.questions || exam.questions.length === 0) return alert("ƒê·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi!");
        
        // T·∫°o b·∫£n sao d·ªØ li·ªáu ƒë·ªÉ x√°o tr·ªôn
        let questionsCopy = JSON.parse(JSON.stringify(exam.questions));
        
        // ƒê·∫£o ƒë·ªÅ t·ª´ng ph·∫ßn
        let q1 = shuffle(questionsCopy.filter(q => q.part === 1));
        q1.forEach(q => {
            let opts = q.a.map((t, idx) => ({ t, is: idx === q.c }));
            shuffle(opts);
            q.a = opts.map(o => o.t);
            q.c = opts.findIndex(o => o.is);
        });
        let q2 = shuffle(questionsCopy.filter(q => q.part === 2));
        let q3 = shuffle(questionsCopy.filter(q => q.part === 3));

        currentQuestions = [...q1, ...q2, ...q3];
        userAnswers = new Array(currentQuestions.length).fill(null);
        
        document.getElementById('menuModal').style.display = 'none';
        document.getElementById('quiz-header').style.display = 'block';
        document.getElementById('nav-section').style.display = 'flex';
        document.getElementById('game-main').style.display = 'grid';
        document.getElementById('stu-name-display').innerText = studentName;
        document.getElementById('stu-class-display').innerText = studentClass;
        document.getElementById('exam-title-main').innerText = exam.title;
        
        initNav(); initNumpad(); render(); startTimer();
    }

    function startTimer() {
        document.getElementById('timer-box').style.display = 'block';
        timerInterval = setInterval(() => {
            if(isFinished) return;
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer-box').innerText = `${m}:${s<10?'0':''}${s}`;
            if(timeLeft <= 300) document.getElementById('timer-box').classList.add('timer-warning');
            if(timeLeft <= 0) finish();
        }, 1000);
    }

    function initNav() {
        const groups = [document.getElementById('nav-p1'), document.getElementById('nav-p2'), document.getElementById('nav-p3')];
        groups.forEach(g => g.innerHTML = '');
        let pCounts = [0,0,0];
        currentQuestions.forEach((q, i) => {
            pCounts[q.part-1]++;
            let b = document.createElement('button');
            b.className = 'nav-btn'; b.id = 'nav-'+i; b.innerText = pCounts[q.part-1];
            b.onclick = () => { currentIdx = i; render(); };
            groups[q.part-1].appendChild(b);
        });
    }

    function initNumpad() {
        const zone = document.getElementById('numpad-btns');
        const keys = [1,2,3,4,5,6,7,8,9,0,'.','-'];
        zone.innerHTML = keys.map(k => `<button class="menu-btn" style="padding:10px" onclick="pressKey('${k}')">${k}</button>`).join('') + 
                         `<button class="menu-btn" style="grid-column:span 3; background:var(--wrong)" onclick="pressKey('C')">X√ìA</button>`;
    }

    function render() {
        const q = currentQuestions[currentIdx];
        let dNum = 0; for(let i=0; i<=currentIdx; i++) { if(currentQuestions[i].part === q.part) dNum++; }
        document.getElementById('part-info').innerText = "PH·∫¶N " + ["I","II","III"][q.part-1];
        document.getElementById('q-title').innerText = "C√¢u " + dNum + ".";
        document.getElementById('q-text').innerHTML = q.q;
        const zone = document.getElementById('ans-zone'); zone.innerHTML = '';
        document.getElementById('numpad-container').style.display = q.type==='v3' ? 'block' : 'none';

        if(q.type==='v1') {
            q.a.forEach((opt, i) => {
                let b = document.createElement('button'); b.className = 'btn' + (userAnswers[currentIdx]===i?' selected':'');
                b.innerHTML = `<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
                b.onclick = () => { userAnswers[currentIdx]=i; render(); updateNav(); }; zone.appendChild(b);
            });
        } else if(q.type==='v2') {
            let cur = userAnswers[currentIdx] || [null,null,null,null];
            q.items.forEach((it, i) => {
                let d = document.createElement('div'); d.className = 'tf-row';
                d.innerHTML = `<span><b>${String.fromCharCode(97+i)})</b> ${it.l}</span><div>
                    <button class='btn-tf ${cur[i]===true?'active-t':''}' onclick='setTF(${i},true)'>ƒê√∫ng</button>
                    <button class='btn-tf ${cur[i]===false?'active-f' :''}' onclick='setTF(${i},false)'>Sai</button></div>`;
                zone.appendChild(d);
            });
        } else { document.getElementById('disp').innerText = userAnswers[currentIdx] || "- - -"; }
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-'+currentIdx).classList.add('active');
        MathJax.typesetPromise();
    }

    function setTF(i, v) { if(!userAnswers[currentIdx]) userAnswers[currentIdx]=[null,null,null,null]; userAnswers[currentIdx][i]=v; render(); updateNav(); }
    function pressKey(k) { let cur = userAnswers[currentIdx] || ""; if(k==='C') cur=""; else if(cur.length<10) cur+=k; userAnswers[currentIdx]=cur; render(); updateNav(); }
    function moveQ(s) { let n=currentIdx+s; if(n>=0 && n<currentQuestions.length) { currentIdx=n; render(); } }
    
    function updateNav() {
        currentQuestions.forEach((q, i) => {
            let b = document.getElementById('nav-'+i), a = userAnswers[i];
            b.classList.remove('done','missing');
            if(q.type==='v2') { if(a && !a.includes(null)) b.classList.add('done'); }
            else { if(a!==null && a!=="") b.classList.add('done'); }
        });
    }

    function submitTest() {
        let missing = [];
        let pCounts = [0,0,0];
        currentQuestions.forEach((q, i) => {
            pCounts[q.part-1]++;
            let a = userAnswers[i];
            if((q.type==='v2' && (!a || a.includes(null))) || (q.type!=='v2' && (a===null || a===""))) {
                missing.push(`C√¢u ${pCounts[q.part-1]} P.${["I","II","III"][q.part-1]}`);
                document.getElementById('nav-'+i).classList.add('missing');
            }
        });
        if(missing.length > 0) return alert("Em ch∆∞a xong:\n" + missing.join(", "));
        if(confirm("X√°c nh·∫≠n n·ªôp b√†i?")) finish();
    }

    function finish() {
        if(isFinished) return; isFinished = true; clearInterval(timerInterval);
        document.getElementById('timer-box').style.display='none';
        let sc = 0;
        currentQuestions.forEach((q, i) => {
            if(q.type==='v1' && userAnswers[i]==q.c) sc += 0.25;
            else if(q.type==='v2' && userAnswers[i]) {
                let c = 0; q.items.forEach((it, j) => { if(userAnswers[i][j]===it.r) c++; });
                sc += [0, 0.1, 0.25, 0.5, 1.0][c];
            } else if(q.type==='v3' && userAnswers[i]==q.c) sc += 0.5;
        });
        const score = parseFloat(sc.toFixed(2));
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: studentName, class: studentClass, score: score }) });
        
        document.getElementById('game-main').style.display='none'; document.getElementById('nav-section').style.display='none'; document.getElementById('quiz-header').style.display='none';
        document.getElementById('final-area').style.display='block'; document.getElementById('final-score').innerText = score;
        
        const cm = document.getElementById('score-comment');
        if(score < 3.5) cm.innerText = "B·∫°n c·∫ßn c·ªë g·∫Øng r·∫•t nhi·ªÅu.";
        else if(score < 5) cm.innerText = "B·∫°n c·∫ßn c·ªë g·∫Øng.";
        else if(score < 6.5) cm.innerText = "ƒêi·ªÉm ch·∫•p nh·∫≠n ƒë∆∞·ª£c.";
        else if(score < 8) cm.innerText = "B·∫°n kh√°.";
        else if(score < 9) cm.innerText = "B·∫°n gi·ªèi.";
        else if(score < 9.8) cm.innerText = "Xu·∫•t s·∫Øc.";
        else cm.innerText = "ƒê·ªânh c·ªßa ch√≥p! üèÜ";

        let html = "";
        let fCounts = [0,0,0];
        currentQuestions.forEach((q, i) => {
            fCounts[q.part-1]++;
            html += `<div class='sol-card'><b>C√¢u ${fCounts[q.part-1]} (Ph·∫ßn ${["I","II","III"][q.part-1]}):</b><br>${q.q}<div style='background:#0d1117; padding:15px; border-radius:8px; margin-top:10px;'>${q.sol}</div></div>`;
        });
        document.getElementById('sol-content').innerHTML = html;
        MathJax.typesetPromise();
    }
</script>
</body>
</html>
